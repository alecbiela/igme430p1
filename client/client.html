<!DOCTYPE html>
<html lang="en">
<head>
  <title>IGME430 Project I</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  <script async src="https://www.youtube.com/iframe_api"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script>
    //OUTSIDE CODE USED - SETUP CODE FROM YOUTUBE IFRAME API
    //https://developers.google.com/youtube/iframe_api_reference

    //globals
	var player;
	var done = false;

	// 3. This function creates an <iframe> (and YouTube player)
	//    after the API code downloads.

	function onYouTubeIframeAPIReady() {
		player = new YT.Player('player', {
		height: '390',
		width: '640',
		videoId: '',
		events: {
			'onReady': onPlayerReady,
			//'onStateChange': onPlayerStateChange
			'onError': function(e) { console.dir(e.data);}
			}
		});
	}

	// 4. The API will call this function when the video player is ready.
	function onPlayerReady(event) {
		event.target.playVideo();
	}

	// 5. The API calls this function when the player's state changes.
	//    The function indicates that when playing a video (state=1),
	//    the player should play for one second and then stop.
	function onPlayerStateChange(event) {
		if (event.data == YT.PlayerState.PLAYING && !done) {
			setTimeout(stopVideo, 1000);
			done = true;
		}
	}
	
	function stopVideo() {
		player.stopVideo();
	}
  </script> 

  <script type="text/babel">
    //handles reponses (xhr onload)
    //takes xhr object and whether we should parse the data (true/false)
    const handleResponse = (xhr, shouldParse) => {
        const pageBody = document.querySelector('#content');
        
        console.dir(xhr.status);
        
        //decide what to do based on status code
        switch(xhr.status) {
          case 200: //success
            pageBody.innerHTML = '<b>Success</b>';
            break;
          case 201: //created
            pageBody.innerHTML = '<b>Created</b>';
            break;
          case 204: //updated
            pageBody.innerHTML = '<b>Updated</b>';
            break;
          case 304: //file not modified
            pageBody.innerHTML = '<b>Not Modified</b>';
            return;
          case 400: //bad request
            pageBody.innerHTML = '<b>Bad Request</b>';
            break;
          case 404: //not found
            pageBody.innerHTML = '<b>Resource Not Found</b>';
            break;
          default: //anything else
            pageBody.innerHTML = '<b>Error - Client cannot parse response</b>';
            break;
        }
        

        const obj = JSON.parse(xhr.response);

        //if we have a message, just print it and leave
        if(obj.message) {
        pageBody.innerHTML += '<p>' + obj.message + '</p>';
        return;
        }

        let bigString = "";

        //loop through and get all users, append to HTML
        Object.keys(obj).forEach(function(k){
        bigString += '<p class="videoResult">Title: ' + k + ' URL: <span id="vUrl">' + obj[k].url + '</span> Rating: ' + obj[k].rating + '</p>';
        });
        
        pageBody.innerHTML = bigString;
    };
    
    //changes the video when one is clicked on from the list
    const changeVideo = (e) => {
        const vidUrl = e.target.textContent;
        const vidID = vidUrl.split('v=')[1].split('&')[0];
        player.loadVideoById(vidID);
    }
    
    //sends an AJAX request to the server
    const sendAjax = (e, formData) => {
        //get form target URL and method (get, post, head, etc.)
        const formAction = formData.getAttribute('action');
        const formMethod = formData.getAttribute('method');
        
        const xhr = new XMLHttpRequest();

        
        xhr.onload = () => { handleResponse(xhr, (formMethod == 'get')); };
        
        //decide what to do based on url
        if(formAction === '/addVideo') {
        
            xhr.open(formMethod, formAction);
            
            //get additional data to send
            const titleContent = formData.querySelector('#titleField');
            const urlContent = formData.querySelector('#urlField');
            
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('Accept', 'application/json');
            
            //format the data to send and send it
            const dataStr = `title=${titleContent.value}&vidUrl=${urlContent.value}`;
            xhr.send(dataStr);
        } else {
            xhr.open('GET', '/getVideos');
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.send();
        }
        
        e.preventDefault();
        return false;
    };
    
	//votes on video
	//FIX THIS (add post)
	const vote = (e, direction) => {
	    const xhr = new XMLHttpRequest();
	  
	    xhr.onload = () => {
		  //onload stub
		  };
		  
		  
		xhr.open('POST', '/vote');
		
		//get additional data to send
		const videoToVote = 'http://www.youtube.com/watch?v=' + player.getVideoData()['video_id'];
		
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.setRequestHeader('Accept', 'application/json');
		
		console.dir(videoToVote);
		
		//format the data to send and send it
		const dataStr = `vidUrl=${videoToVote}&direction=${direction}`;
		xhr.send(dataStr); 
		
		e.preventDefault();
		return false;
	};
	
    //init function called at page load
    const init = () => {
      
        //set up globals/event handlers
        const videoForm = document.querySelector('#videoForm');
        const videoList = document.querySelector('#videoList');
        const addVideo = (e) => { sendAjax(e, videoForm); };
        const getUsers = (e) => { sendAjax(e, videoList); };
        document.querySelector('#content').addEventListener('click', (e) => {
          if(event.target.tagName.toLowerCase() === 'span'){
            changeVideo(e);
          }
			
        });
		
		document.querySelector('#tUp').addEventListener('click', (e) => { vote(e,'up'); });
        document.querySelector('#tDown').addEventListener('click', (e) => { vote(e,'down'); });
		
        videoForm.addEventListener('submit', addVideo);
        videoList.addEventListener('submit', getUsers);
    };
    
    window.onload = init;   
  </script>

</head>
<body>
  <section id="top">
    <h3>Add a video to the list:</h3>
	<p><i>YouTube Only - Assume all videos are NSFW</i></p>
    <form id="videoForm" action="/addVideo" method="POST">
      <label for="title">Title: </label>
      <input id="titleField" type="text" name="title" />
      <label for="urlS">YouTube URL: </label>
      <input id="urlField" type="text" name="urlS" />
      <input type="submit" value="Add Video!" />
    </form>
    
    
    <form id="videoList" action="/getVideos" method="GET">
      <br />
      <br />
      <input type="submit" value="Get All Videos" />
    </form>
  </section>
  
  <section id="features">
    <p>Current Features</p>
    <ul>
      <li>Youtube IFrame API used to play videos</li>
      <li>Enter a title/caption and Video URL to add a video to the Queue</li>
      <li>Click the 'Get Videos' Button to get all submitted Videos</li>
      <li>Click on a video URL from the list that appears to play that video</li>
      <li>Bad request given if youtube URL field is not a URL to youtube.com</li>
      <li>Bad request given if either field is empty</li>
    </ul>
    <p>Planned Additions</p>
    <ul>    
      <li>More CSS</li>
      <li>Upvoting and downvoting of videos (rating)</li>
      <li>Handling of Youtube API Errors?</li>
      <li>Better formatting of results(again, more CSS)</li>
    </ul>
  </section>
  
  <!-- Content will display here once we've loaded some -->
  <section id="content">
  </section>
  
    <br/>
    <br/>
      <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <div id="player"></div>
	
	<img id="tUp" src="thumbs_up.svg" alt="Thumbs Up!" />
	<img id="tDown" src="thumbs_down.svg" alt="Thumbs Down!" />

    

</body>
</html>